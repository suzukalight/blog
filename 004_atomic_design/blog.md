# Atomic Designを運用してみて

# 運用前の問題

- コンポーネントの粒度がバラバラ
    - 超巨大なモノリシックコンポーネント
    - Storeを見に行っているが、別にprops渡しでもなんとかなるようなコンポーネント
        - 別のコンポーネントの一部として取り込まれることは、まるで意識していない
    - つまり、責任分界点が曖昧
- 特定の機能を充足することに目が行き過ぎ
    - 似たような別のコンポーネントを作りがち
    - 前提となるコンポーネントが多い、ハイパー密結合なコンポーネントが数多く爆誕
- コンポーネントのテストが存在しない
    - そもそもテスタビリティを考慮していない
        - テストの習慣がないので、テスタビリティのないロジックが散見
    - すぐデグレる（特にスタイル）

あるあるかもしれないが、非常にお恥ずかしい。
完璧より完成を目指していたこともあるが、、、
実装担当者が増えてきた、だがドキュメントがない、みんな好き勝手に作り出す前に、指針をつくるべき

# Atomic Designについて

世間に事例も多い昨今、いまさら多くを語る必要もないので、簡単に。

# 運用方針

- エンジニア向けのコンポーネントガイドラインとして利用
    - 責任分界点を明確化する
    - コンポーネントテスタビリティを向上させること
    - 流用可能性を上げること
- フロントエンドにおける状態管理の基準が、レイヤー分けの基準になった

## 責任分界点

- atom/molecule/organism/pageの責任点を確定させる
    - pages: URL情報に直接アクセスできる
    - organisms: Storeにconnectできる・APIコールできる
    - molecules: ユーザに対して有意な情報の集合を表示できる（Objectくらい）
    - atoms: デザインの乗ったpやinput要素くらいの感じ、使い回し前提

### pages

ex.ホーム画面

URLに対する責任を持つ層です。SPAにおけるルーティング層になります。React-RouterのSwitch-Routerをexportするコンポーネントを想定します。

```
// routing.js

export const Home = () => (
  <Switch>
    <Route path={Url.home.index} component={HomeRoot} />
    ...
  </Switch>
);
```

もうひとつの役割は、子コンポーネントへpropsとしてURL情報をパースして与えることです。子コンポーネントがどのエンティティに関する情報を表示すべきかの指示を与えます。

結果として、pagesは子コンポーネントのレイアウトを担当する形になり、それ以上の機能は持ちません。

```
<div className="pHome">
  <div className="pHome__stats">
    <Stats userId={userId} />
  </div>
  <div className="pHome__objectives">
    <Objectives userId={userId} />
  </div>
  ...
</div>
```

ちょっとしたテクニックとしては、この単位でcode-splittingすることで、初回ローディングの負荷を減らしています。

### organisms

ex.コメント欄

Storeにアクセスできる層です。

pages層からエンティティIDなどを指示されることで、必要な情報をStoreから拾い上げ、表示可能な情報へと変換し、子コンポーネントにpropsとして渡すレイヤとして考えます。なのでselectorが一番発達している層です。

```
createStructuredSelector
```

もうひとつの役割は、APIにアクセスし、エンティティの更新を行うことです。この層が最も多くのhandleメソッドを持ちます。

```
class Timeline {
    handlePostNode = values => { }
}
```

全体的に、エンティティへの操作を考える

### molecules

ex.コメントノード

エンティティの全部または一部を、実際にレンダリングする層です。ユーザにとって意味のある情報の集合体であることを想定しています。

```
```

デザイン要素としてのatomsや、UIパーツとしてのatomsなど、atomsを組み合わせて組み立てていくことが期待されます。そうすることでデザインの統一性を担保しやすくなると思います。

### atoms

ex.UIパーツ（アバターやフォーム）

ユーザとのインタラクションの1つを表現する層です。この層は、エンティティを自身で解釈することはなく、propsで渡された情報をもとに、HTML要素と連結することに重点を置いています。

- 編集ギアメニュー
- アバター

1つの機能部品として、独立した表示状態を提供することが多いため、this.stateで自身の表示状態を管理することも多いです。このstateはアプリのエンティティと紐付かない限りは、自由に作成できます。

```
class Accordion extends React.Component {
    state = { show: false };

    handleToggle = () => { this.setState(prev => ({ ...prev, show: !prev.show }))}
}
```

## 流用可能性

- propsにのみ依存させる
    - Storeに依存させると、流用性がなくなる
- 揮発的な表示変更は、Reduxを通さず、this.stateを使う
    - アプリの状態には影響しないため
- デザインも、上位のコンポーネントがw/h/margin/positionを規定する
    - 自身はborder領域まで。paddingなどは自身の管轄内であり、規定してよい
    - 

## テスタビリティ

- storybook：目視テスト
    - パターンだしを行うこと
    - コード例
- storyshots：デグレテスト
    - コード例
- jest：ロジックテスト
    - レンダリングと変換ロジックを分離コーディング
    - コード例
- (WIP) puppeteer：E2Eテスト
- (WIP) image-snap：visual regression testing

# 結果

ディレクトリツリー

```
- /components
  - /atoms
    - /_forms
  - /molecules
  - /organisms
  - /pages
```

## 効果

コンポーネントの責任分界点が確立できたことにより、明確な分業を体制化できました。

- molecules層とorganisms層での並列作業が可能に
    - settingsで実現
    - 見た目を作り込む担当と、ロジックを作り込む担当が分かれる感じで動けた
- JSXとpropsだけ先に記述し、マークアップとロジックを並列作業可能に
    - timelineで実現
    - storybookでマークアップを完結でき、ローカルサーバが不要に

# 課題

- これってデザイン観点でのAtomic Designとは違うのでは？
    - 違うと思う
    - molecules/organismsあたりの切り分け基準は、ロジック的な観点が大きい
    - デザイナと協働するときに、そこのすり合わせは必要だと思う
- atomにformパーツが集中
    - 理屈上そうなる
    - 見通しが悪くなってきたため、_formsのサブディレクトリを切ってしまう羽目に
        - 弊社だとredux-form前提なので、forms配下はredux-form前提コンポーネントですよ、と表明したかったのもある
- atoms/moleculesの境界あいまい問題
    - よく私が指摘される
    - moleculesは、atomを組み合わせた時点で、デザイン観点からはmolecules一択だが…
- organismsに過剰分割しがち
    - pagesがただのrouting層なので
    - organismsを水平管理すると、コンポーネントが100個とかできる
        - 垂直管理するか、使い回さないならpagesに置くべき
        - 使い回さないコンポーネントは、無理にexportしない
- 使い回さないコンポーネントの位置
    - 使い回さないのに、共通moleculesディレクトリに入っている
        - 使い回さないなら、その親コンポーネントの配下で良いのでは？
        - 「使い回すコンポーネント」置き場としての、 `/molecules` とかが望ましいと考えている
- storyshotsのデグレテストが疎かになりがち
    - スタイルのデグレチェックができていないので、効果が半減
        - cssもsnapshotに含んでしまってテストしてもよいのでは

# 運用後の展開

- デザインシステムの構築を開始
    - デザイナがADを学習してくれて、デザインシステムにADを採用してくれた
    - デザインとコンポーネントが1:1につながる世界を目指す
    - フロントエンド観点からのAtomic Designになっているので、デザイナとすり合せていく
- E2Eテストの検討
    - 機能レベルでのテストができていない
    - enzymeも特に使っていない


