# Atomic Designを運用してみて

# 運用前の問題

- コンポーネントの粒度がバラバラ
    - つまり、責任分界点が曖昧
    - 例
- 特定の機能を充足することに目が行き過ぎ
    - 似たようなコンポーネントを作りがち
    - 前提となるコンポーネントが多く、ハイパー密結合なコンポーネントが数多く爆誕
    - Storeをガッツリ見に行っており、Storeがないと成立しない
    - 別のコンポーネントの一部として取り込まれることは、まるで意識していない
- コンポーネントのテストが存在しない
    - そもそもテスタビリティを考慮できていない
    - すぐデグレる（特にスタイル）
    - テストの習慣がないので、テスタビリティのないロジックが量産

あるあるかもしれないが、非常にお恥ずかしい。
完璧より完成を目指していたこともあるが、、、
実装担当者が増えてきた、だがドキュメントがない、みんな好き勝手に作り出す前に、指針をつくるべき

# Atomic Designについて

世間に事例も多い昨今、いまさら多くを語る必要もないので、簡単に。

# 運用方針

- 基本的には、エンジニア向けのコンポーネントガイドラインとして仕様策定
    - 責任分界点を明確化する
    - コンポーネントテスタビリティを向上させること
    - 流用可能性を上げること
- フロントエンドにおける状態管理の基準が、レイヤー分けの基準になった

## 責任分界点

- atom/molecule/organism/pageの責任点を確定させる
    - pages: URL情報に直接アクセスできる
    - organisms: Storeにconnectできる・APIコールできる
    - molecules: ユーザに対して有意な情報の集合を表示できる（Objectくらい）
    - atoms: 使い回せる、デザインの乗った1つのDOM要素くらいの感じ

### pages

ex.ホーム画面

この層は、SPAにおけるルーティング層になります。なのでReact-RouterのSwitch-Routeが露出することを想定しています。

routing.js

```
<Switch><Route/></Switch>
```

もうひとつの役割は、子コンポーネントへpropsとしてURL情報をパースして与えることです。子コンポーネントがどのエンティティに関する情報を表示すべきかの指示を与えます。

ちょっとしたテクニックとしては、この単位でcode-splittingすることで、初回ローディングの負荷を減らしています。


### organisms

ex.コメント欄

この層までが、Storeにアクセスできます。pages層から、自身が表現すべきエンティティのIDなどを指示されることで、必要な情報をStoreから拾い上げ、表示可能な情報へと変換し、子コンポーネントにpropsとして渡すレイヤとして考えます。なのでselectorが一番発達している層です。

```
createStructuredSelector
```

もうひとつの役割は、APIにアクセスし、エンティティの更新を行うことです。この層が最も多くのhandleメソッドを持ちます。

```
class Timeline {
    handlePostNode = values => { }
}
```

### molecules

ex.ノード

Nodeエンティティをレンダリングするもの

### atoms

ex.UIパーツ（アバターやフォーム）

この層は、エンティティを直接表現しません。代わりに、ユーザへのインタラクションの1つを表現します。

- 編集ギアメニュー
- アバター

独立した表示状態を提供することが多く、this.stateで表示のログるなどを行ったりもする

## テスタビリティ

- storybookによる目視テスト、およびパターンだしを行うこと
- storyshotsによるデグレテストを行うこと
- 変換ロジックを分離すること

## 流用可能性

- propsにのみ依存させる
    - Storeに依存させると、流用性がなくなる
- 揮発的な表示変更は、Reduxを通さず、this.stateを使う
    - アプリの状態には影響しないため
- デザインも、上位のコンポーネントがw/h/margin/positionを規定する
    - 自身はborder領域まで。paddingなどは自身の管轄内であり、規定してよい
    - 

# 結果

ディレクトリツリー

- molecules層とorganisms層での並列作業が可能に
    - settingsで実現
- JSXだけ先に記述し、マークアップとロジックを並列作業可能に
    - timelineで実現
- 

# 課題

- atomにformパーツが集中
    - _formsのサブディレクトリを切ってしまう羽目に
- atoms/moleculesの境界あいまい問題
    - よく私が指摘される
- organismsに過剰分割しがち
    - pagesがただのrouting層に
    - organismsを水平管理すると、コンポーネントが100個とかできる
        - 垂直管理するか、pagesに置くべき
        - 使い回さないコンポーネントは、無理にexportしない
- storyshotsのデグレテストが疎かになりがち
    - スタイルのデグレチェックができていないので、効果が半減
        - cssもsnapshotに入れてテストしてもよいのでは

# 運用後の展開

- デザインシステムの構築を開始
    - デザイナがADを学習してくれて、デザインシステムとADを採用してくれた
    - FigmaとReactの結合を目指す
- E2Eテストの検討
    - 


